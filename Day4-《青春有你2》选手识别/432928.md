# PaddleHubä¹‹ã€Šé’æ˜¥æœ‰ä½ 2ã€‹ä½œä¸šï¼šäº”äººè¯†åˆ«

## ä¸€ã€ä»»åŠ¡ç®€ä»‹

å›¾åƒåˆ†ç±»æ˜¯è®¡ç®—æœºè§†è§‰çš„é‡è¦é¢†åŸŸï¼Œå®ƒçš„ç›®æ ‡æ˜¯å°†å›¾åƒåˆ†ç±»åˆ°é¢„å®šä¹‰çš„æ ‡ç­¾ã€‚è¿‘æœŸï¼Œè®¸å¤šç ”ç©¶è€…æå‡ºå¾ˆå¤šä¸åŒç§ç±»çš„ç¥ç»ç½‘ç»œï¼Œå¹¶ä¸”æå¤§çš„æå‡äº†åˆ†ç±»ç®—æ³•çš„æ€§èƒ½ã€‚æœ¬æ–‡ä»¥è‡ªå·±åˆ›å»ºçš„æ•°æ®é›†ï¼šé’æ˜¥æœ‰ä½ 2ä¸­é€‰æ‰‹è¯†åˆ«ä¸ºä¾‹å­ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨PaddleHubè¿›è¡Œå›¾åƒåˆ†ç±»ä»»åŠ¡ã€‚

<div  align="center">   
<img src="https://ai-studio-static-online.cdn.bcebos.com/dbaf5ba718f749f0836c342fa67f6d7954cb89f3796b4c8b981a03a1635f2fbe" width = "350" height = "250" align=center />
</div>



```python
#CPUç¯å¢ƒå¯åŠ¨è¯·åŠ¡å¿…æ‰§è¡Œè¯¥æŒ‡ä»¤
%set_env CPU_NUM=1 
```

    env: CPU_NUM=1



```python
#å®‰è£…paddlehub
# !pip install paddlehub==1.6.0 -i https://pypi.tuna.tsinghua.edu.cn/simple
```

## äºŒã€ä»»åŠ¡å®è·µ
### Step1ã€åŸºç¡€å·¥ä½œ

åŠ è½½æ•°æ®æ–‡ä»¶

å¯¼å…¥pythonåŒ…


```python
# !unzip -o ./dataset/file.zip -d ./dataset/pic/
```


```python
import os
name_list=['ysx','xjq','zxt','aq','wcx']
dic={'ysx': 0, 'xjq': 1, 'zxt': 2, 'aq': 3, 'wcx': 4}
validate_list=[]
train_list=[]
list={'validate_list':validate_list,'train_list':train_list}


def findfiles(path,label):
    result=[]
    for root, dirs, files in os.walk(path):
        for name in files:
            # print(root[8:]+'/'+name)
            result.append(root[8:]+'/'+name+' '+str(label))
    for i in range(len(result)):
        if (i%10==0):
            validate_list.append(result[i])
            # print(result[i])
        else:
            train_list.append(result[i])

def save_txt(listname):
    # print('dataset/'+listname+'.txt')
    with open('dataset/'+listname+'.txt',mode='w') as f:
        for i in list[listname]:
            f.write(i+'\n')

for name in name_list:
    findfiles('dataset/pic/'+name,dic[name])
save_txt('validate_list')
save_txt('train_list')
```


```python
import paddlehub as hub
```

### Step2ã€åŠ è½½é¢„è®­ç»ƒæ¨¡å‹

æ¥ä¸‹æ¥æˆ‘ä»¬è¦åœ¨PaddleHubä¸­é€‰æ‹©åˆé€‚çš„é¢„è®­ç»ƒæ¨¡å‹æ¥Finetuneï¼Œç”±äºæ˜¯å›¾åƒåˆ†ç±»ä»»åŠ¡ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ç»å…¸çš„ResNet-50ä½œä¸ºé¢„è®­ç»ƒæ¨¡å‹ã€‚PaddleHubæä¾›äº†ä¸°å¯Œçš„å›¾åƒåˆ†ç±»é¢„è®­ç»ƒæ¨¡å‹ï¼ŒåŒ…æ‹¬äº†æœ€æ–°çš„ç¥ç»ç½‘ç»œæ¶æ„æœç´¢ç±»çš„PNASNetï¼Œæˆ‘ä»¬æ¨èæ‚¨å°è¯•ä¸åŒçš„é¢„è®­ç»ƒæ¨¡å‹æ¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚


```python
module = hub.Module(name="resnet_v2_50_imagenet")
```

    [32m[2020-04-26 22:33:39,934] [    INFO] - Installing resnet_v2_50_imagenet module[0m
    [32m[2020-04-26 22:33:40,105] [    INFO] - Module resnet_v2_50_imagenet already installed in /home/aistudio/.paddlehub/modules/resnet_v2_50_imagenet[0m


### Step3ã€æ•°æ®å‡†å¤‡

æ¥ç€éœ€è¦åŠ è½½å›¾ç‰‡æ•°æ®é›†ã€‚æˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰çš„æ•°æ®è¿›è¡Œä½“éªŒï¼Œè¯·æŸ¥çœ‹[é€‚é…è‡ªå®šä¹‰æ•°æ®](https://github.com/PaddlePaddle/PaddleHub/wiki/PaddleHubé€‚é…è‡ªå®šä¹‰æ•°æ®å®ŒæˆFineTune)


```python
from paddlehub.dataset.base_cv_dataset import BaseCVDataset
   
class DemoDataset(BaseCVDataset):	
   def __init__(self):	
       # æ•°æ®é›†å­˜æ”¾ä½ç½®
       
       self.dataset_dir = "dataset"
       super(DemoDataset, self).__init__(
           base_path=self.dataset_dir,
           train_list_file="train_list.txt",
           validate_list_file="validate_list.txt",
           test_list_file="test_list.txt",
           label_list_file="label_list.txt",
           )
dataset = DemoDataset()
```

### Step4ã€ç”Ÿæˆæ•°æ®è¯»å–å™¨

æ¥ç€ç”Ÿæˆä¸€ä¸ªå›¾åƒåˆ†ç±»çš„readerï¼Œreaderè´Ÿè´£å°†datasetçš„æ•°æ®è¿›è¡Œé¢„å¤„ç†ï¼Œæ¥ç€ä»¥ç‰¹å®šæ ¼å¼ç»„ç»‡å¹¶è¾“å…¥ç»™æ¨¡å‹è¿›è¡Œè®­ç»ƒã€‚

å½“æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå›¾åƒåˆ†ç±»çš„readeræ—¶ï¼Œéœ€è¦æŒ‡å®šè¾“å…¥å›¾ç‰‡çš„å¤§å°


```python
data_reader = hub.reader.ImageClassificationReader(
    image_width=module.get_expected_image_width(),
    image_height=module.get_expected_image_height(),
    images_mean=module.get_pretrained_images_mean(),
    images_std=module.get_pretrained_images_std(),
    dataset=dataset)
```

    [32m[2020-04-26 22:34:16,248] [    INFO] - Dataset label map = {'è™ä¹¦æ¬£': 0, 'è®¸ä½³çª': 1, 'èµµå°æ£ ': 2, 'å®‰å´': 3, 'ç‹æ‰¿æ¸²': 4}[0m


### Step5ã€é…ç½®ç­–ç•¥
åœ¨è¿›è¡ŒFinetuneå‰ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€äº›è¿è¡Œæ—¶çš„é…ç½®ï¼Œä¾‹å¦‚å¦‚ä¸‹ä»£ç ä¸­çš„é…ç½®ï¼Œè¡¨ç¤ºï¼š

* `use_cuda`ï¼šè®¾ç½®ä¸ºFalseè¡¨ç¤ºä½¿ç”¨CPUè¿›è¡Œè®­ç»ƒã€‚å¦‚æœæ‚¨æœ¬æœºæ”¯æŒGPUï¼Œä¸”å®‰è£…çš„æ˜¯GPUç‰ˆæœ¬çš„PaddlePaddleï¼Œæˆ‘ä»¬å»ºè®®æ‚¨å°†è¿™ä¸ªé€‰é¡¹è®¾ç½®ä¸ºTrueï¼›

* `epoch`ï¼šè¿­ä»£è½®æ•°ï¼›

* `batch_size`ï¼šæ¯æ¬¡è®­ç»ƒçš„æ—¶å€™ï¼Œç»™æ¨¡å‹è¾“å…¥çš„æ¯æ‰¹æ•°æ®å¤§å°ä¸º32ï¼Œæ¨¡å‹è®­ç»ƒæ—¶èƒ½å¤Ÿå¹¶è¡Œå¤„ç†æ‰¹æ•°æ®ï¼Œå› æ­¤batch_sizeè¶Šå¤§ï¼Œè®­ç»ƒçš„æ•ˆç‡è¶Šé«˜ï¼Œä½†æ˜¯åŒæ—¶å¸¦æ¥äº†å†…å­˜çš„è´Ÿè·ï¼Œè¿‡å¤§çš„batch_sizeå¯èƒ½å¯¼è‡´å†…å­˜ä¸è¶³è€Œæ— æ³•è®­ç»ƒï¼Œå› æ­¤é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„batch_sizeæ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼›

* `log_interval`ï¼šæ¯éš”10 stepæ‰“å°ä¸€æ¬¡è®­ç»ƒæ—¥å¿—ï¼›

* `eval_interval`ï¼šæ¯éš”50 stepåœ¨éªŒè¯é›†ä¸Šè¿›è¡Œä¸€æ¬¡æ€§èƒ½è¯„ä¼°ï¼›

* `checkpoint_dir`ï¼šå°†è®­ç»ƒçš„å‚æ•°å’Œæ•°æ®ä¿å­˜åˆ°cv_finetune_turtorial_demoç›®å½•ä¸­ï¼›

* `strategy`ï¼šä½¿ç”¨DefaultFinetuneStrategyç­–ç•¥è¿›è¡Œfinetuneï¼›

æ›´å¤šè¿è¡Œé…ç½®ï¼Œè¯·æŸ¥çœ‹[RunConfig](https://github.com/PaddlePaddle/PaddleHub/wiki/PaddleHub-API:-RunConfig)

åŒæ—¶PaddleHubæä¾›äº†è®¸å¤šä¼˜åŒ–ç­–ç•¥ï¼Œå¦‚`AdamWeightDecayStrategy`ã€`ULMFiTStrategy`ã€`DefaultFinetuneStrategy`ç­‰ï¼Œè¯¦ç»†ä¿¡æ¯å‚è§[ç­–ç•¥](https://github.com/PaddlePaddle/PaddleHub/wiki/PaddleHub-API:-Strategy)


```python
config = hub.RunConfig(
    use_cuda=True,                              #æ˜¯å¦ä½¿ç”¨GPUè®­ç»ƒï¼Œé»˜è®¤ä¸ºFalseï¼›
    num_epoch=40,                                #Fine-tuneçš„è½®æ•°ï¼›
    checkpoint_dir="cv_finetune_turtorial_demo",#æ¨¡å‹checkpointä¿å­˜è·¯å¾„, è‹¥ç”¨æˆ·æ²¡æœ‰æŒ‡å®šï¼Œç¨‹åºä¼šè‡ªåŠ¨ç”Ÿæˆï¼›
    batch_size=3,                              #è®­ç»ƒçš„æ‰¹å¤§å°ï¼Œå¦‚æœä½¿ç”¨GPUï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´batch_sizeï¼›
    eval_interval=10,                           #æ¨¡å‹è¯„ä¼°çš„é—´éš”ï¼Œé»˜è®¤æ¯100ä¸ªstepè¯„ä¼°ä¸€æ¬¡éªŒè¯é›†ï¼›
    strategy=hub.finetune.strategy.DefaultFinetuneStrategy())  #Fine-tuneä¼˜åŒ–ç­–ç•¥ï¼›
```

    [32m[2020-04-26 22:34:19,321] [    INFO] - Checkpoint dir: cv_finetune_turtorial_demo[0m


### Step6ã€ç»„å»ºFinetune Task
æœ‰äº†åˆé€‚çš„é¢„è®­ç»ƒæ¨¡å‹å’Œå‡†å¤‡è¦è¿ç§»çš„æ•°æ®é›†åï¼Œæˆ‘ä»¬å¼€å§‹ç»„å»ºä¸€ä¸ªTaskã€‚

ç”±äºè¯¥æ•°æ®è®¾ç½®æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»çš„ä»»åŠ¡ï¼Œè€Œæˆ‘ä»¬ä¸‹è½½çš„åˆ†ç±»moduleæ˜¯åœ¨ImageNetæ•°æ®é›†ä¸Šè®­ç»ƒçš„åƒåˆ†ç±»æ¨¡å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹æ¨¡å‹è¿›è¡Œç®€å•çš„å¾®è°ƒï¼ŒæŠŠæ¨¡å‹æ”¹é€ ä¸ºä¸€ä¸ªäºŒåˆ†ç±»æ¨¡å‹ï¼š

1. è·å–moduleçš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ŒåŒ…æ‹¬è¾“å…¥å’Œè¾“å‡ºçš„å˜é‡ï¼Œä»¥åŠPaddle Programï¼›
2. ä»è¾“å‡ºå˜é‡ä¸­æ‰¾åˆ°ç‰¹å¾å›¾æå–å±‚feature_mapï¼›
3. åœ¨feature_mapåé¢æ¥å…¥ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œç”ŸæˆTaskï¼›


```python
input_dict, output_dict, program = module.context(trainable=True)
img = input_dict["image"]
feature_map = output_dict["feature_map"]
feed_list = [img.name]

task = hub.ImageClassifierTask(
    data_reader=data_reader,
    feed_list=feed_list,
    feature=feature_map,
    num_classes=dataset.num_labels,
    config=config)
```

    [32m[2020-04-26 22:34:19,686] [    INFO] - 267 pretrained paramaters loaded by PaddleHub[0m


### Step5ã€å¼€å§‹Finetune

æˆ‘ä»¬é€‰æ‹©`finetune_and_eval`æ¥å£æ¥è¿›è¡Œæ¨¡å‹è®­ç»ƒï¼Œè¿™ä¸ªæ¥å£åœ¨finetuneçš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‘¨æœŸæ€§çš„è¿›è¡Œæ¨¡å‹æ•ˆæœçš„è¯„ä¼°ï¼Œä»¥ä¾¿æˆ‘ä»¬äº†è§£æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹çš„æ€§èƒ½å˜åŒ–ã€‚


```python
run_states = task.finetune_and_eval()
```

    [32m[2020-04-26 22:47:07,223] [    INFO] - PaddleHub finetune finished.[0m

### Step6ã€é¢„æµ‹

å½“Finetuneå®Œæˆåï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡å‹æ¥è¿›è¡Œé¢„æµ‹ï¼Œå…ˆé€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥è·å–æµ‹è¯•çš„å›¾ç‰‡


```python
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.image as mpimg

with open("dataset/test_list.txt","r") as f:
    filepath = f.readlines()

data = ['dataset/'+filepath[0].split(" ")[0],'dataset/'+filepath[1].split(" ")[0],'dataset/'+filepath[2].split(" ")[0],'dataset/'+filepath[3].split(" ")[0],'dataset/'+filepath[4].split(" ")[0]]

label_map = dataset.label_dict()
index = 0
run_states = task.predict(data=data)
results = [run_state.run_results for run_state in run_states]

for batch_result in results:
    print(batch_result)
    batch_result = np.argmax(batch_result, axis=2)[0]
    print(batch_result)
    for result in batch_result:
        index += 1
        result = label_map[result]
        print("input %i is %s, and the predict result is %s" %
              (index, data[index - 1], result))

```

    [32m[2020-04-26 22:47:07,489] [    INFO] - PaddleHub predict start[0m
    [32m[2020-04-26 22:47:07,490] [    INFO] - The best model has been loaded[0m
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/executor.py:804: UserWarning: There are no operators in the program to be executed. If you pass Program manually, please use fluid.program_guard to ensure the current Program is being used.
      warnings.warn(error_info)
    share_vars_from is set, scope is ignored.
    [32m[2020-04-26 22:47:08,198] [    INFO] - PaddleHub predict finished.[0m


    [array([[2.1039845e-02, 6.7897998e-03, 2.0897365e-03, 2.1041687e-01,
            7.5966370e-01],
           [7.1982878e-01, 1.2698115e-01, 1.2322441e-01, 2.1504462e-02,
            8.4611513e-03],
           [4.0365945e-04, 8.0442529e-05, 9.5765042e-01, 4.1443419e-02,
            4.2189370e-04]], dtype=float32)]
    [4 0 2]
    input 1 is dataset/test/yushuxin.jpg, and the predict result is ç‹æ‰¿æ¸²
    input 2 is dataset/test/xujiaqi.jpg, and the predict result is è™ä¹¦æ¬£
    input 3 is dataset/test/zhaoxiaotang.jpg, and the predict result is èµµå°æ£ 
    [array([[4.2543790e-01, 2.2883233e-02, 2.4440752e-02, 6.9748610e-04,
            5.2654070e-01],
           [2.2233035e-01, 4.1934424e-03, 2.3643067e-02, 1.0153881e-03,
            7.4881780e-01]], dtype=float32)]
    [4 4]
    input 4 is dataset/test/anqi.jpg, and the predict result is ç‹æ‰¿æ¸²
    input 5 is dataset/test/wangchengxuan.jpg, and the predict result is ç‹æ‰¿æ¸²



```python

```


```python

```
